name: Scan container image with OSV-Scanner
on:
  workflow_call:
    inputs:
      containerfile:
        description: |
          Path to the Containerfile. The image will be built and then scanned.
        required: true
        type: string
      image-tag:
        description: 'Tag for the built image.'
        required: false
        type: string
        default: 'test'
      fail-on-severity:
        description: 'The minimum severity to fail the scan on. Can be one of: critical, high, medium, low.'
        required: false
        type: string
        default: 'high'
      runs-on:
        required: false
        type: string
        default: "ubuntu-latest"

permissions:
  contents: read
  packages: write

jobs:
  build-and-scan:
    runs-on: ${{ inputs.runs-on }}
    container:
      image: ubuntu:24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Install dependencies
        run: |
          apt-get update && apt-get install -y curl ca-certificates git jq

      - name: Setup Tools
        run: |
          # Install Kaniko Executor (Using maintained binaries)
          curl -Lo /usr/local/bin/executor https://github.com/GoogleContainerTools/kaniko/releases/download/v1.23.2/executor-linux-amd64
          chmod +x /usr/local/bin/executor

          # Install OSV-Scanner
          curl -Lo /usr/local/bin/osv-scanner https://github.com/google/osv-scanner/releases/download/v1.9.2/osv-scanner_1.9.2_linux_amd64
          chmod +x /usr/local/bin/osv-scanner

      - name: Build and Push Image (Kaniko)
        id: build
        run: |
          # 1. Define Image Name
          REPO_OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          IMAGE_NAME="ghcr.io/$REPO_OWNER/osv-scan-target:${{ inputs.image-tag }}-${{ github.run_id }}"

          echo "Building image: $IMAGE_NAME"

          # 2. Configure Auth
          mkdir -p /kaniko/.docker
          echo "{\"auths\":{\"ghcr.io\":{\"username\":\"${{ github.actor }}\",\"password\":\"${{ secrets.GITHUB_TOKEN }}\"}}}}" > /kaniko/.docker/config.json

          # 3. Build with Kaniko
          /usr/local/bin/executor \
            --context "git://github.com/${{ github.repository }}#${{ github.sha }}" \
            --context-sub-path "$(dirname ${{ inputs.containerfile }})" \
            --dockerfile "${{ inputs.containerfile }}" \
            --destination "$IMAGE_NAME" \
            --cache=true \
            --force

          echo "image=$IMAGE_NAME" >> $GITHUB_OUTPUT
        env:
          GIT_USERNAME: ${{ github.actor }}
          GIT_PASSWORD: ${{ secrets.GITHUB_TOKEN }}

      - name: Scan Image
        run: |
          IMAGE="${{ steps.build.outputs.image }}"
          OUTPUT_FILE="scan-results.txt"

          echo "Scanning image: $IMAGE"

          osv-scanner scan image "$IMAGE" > "$OUTPUT_FILE" || true
          cat "$OUTPUT_FILE"

          SUMMARY_LINE=$(grep 'Total .* packages affected by' "$OUTPUT_FILE")

          if [ -z "$SUMMARY_LINE" ]; then
            echo "No vulnerabilities found."
            exit 0
          fi

          get_count() {
            local count=$(echo "$2" | grep -o "[0-9]* $1" | awk '{print $1}')
            echo "${count:-0}"
          }

          CRITICAL=$(get_count "Critical" "$SUMMARY_LINE")
          HIGH=$(get_count "High" "$SUMMARY_LINE")
          MEDIUM=$(get_count "Medium" "$SUMMARY_LINE")
          LOW=$(get_count "Low" "$SUMMARY_LINE")

          FAIL_THRESHOLD="${{ inputs.fail-on-severity }}"
          SHOULD_FAIL=0

          case "$FAIL_THRESHOLD" in
            low) if (( CRITICAL > 0 || HIGH > 0 || MEDIUM > 0 || LOW > 0 )); then SHOULD_FAIL=1; fi ;;
            medium) if (( CRITICAL > 0 || HIGH > 0 || MEDIUM > 0 )); then SHOULD_FAIL=1; fi ;;
            high) if (( CRITICAL > 0 || HIGH > 0 )); then SHOULD_FAIL=1; fi ;;
            critical) if (( CRITICAL > 0 )); then SHOULD_FAIL=1; fi ;;
          esac

          if [[ "$SHOULD_FAIL" -eq 1 ]]; then
            echo "::error::Scan failed due to ${FAIL_THRESHOLD}+ severity vulnerabilities."
            exit 1
          fi
        shell: bash
