name: Builds container image with cache
on:
  workflow_call:
    inputs:
      context:
        description: Context for the build (default ".")
        required: true
        type: string
        default: .
      file:
        description: Path to the Dockerfile. (default Dockerfile)
        required: true
        type: string
        default: Dockerfile
      tags:
        description: Comma separated list of tags (name/app:latest,name/app:1.0.0)
        required: true
        type: string
      push:
        description: Whether to push the image (default true)
        required: false
        type: boolean
        default: true
      cache-repo:
        description: Registry repository to use for caching
        required: false
        type: string
      runs-on:
        required: false
        type: string
        default: "ubuntu-latest"

permissions:
  contents: read
  packages: write

jobs:
  build-and-scan:
    runs-on: ${{ inputs.runs-on }}
    container:
      image: cgr.dev/chainguard/kaniko:1.25.5
    steps:
      - name: Build and Push with Kaniko
        run: |
          # 1. Configure Authentication for GHCR
          echo "{\"auths\":{\"ghcr.io\":{\"username\":\"${{ github.actor }}\",\"password\":\"${{ secrets.GITHUB_TOKEN }}\"}}}}" > /kaniko/.docker/config.json

          # 2. Process Tags into Destinations
          DESTINATIONS=""
          CLEAN_TAGS=$(echo "${{ inputs.tags }}" | tr ',' ' ')
          FIRST_TAG=""
          for tag in $CLEAN_TAGS; do
            if [ -z "$FIRST_TAG" ]; then FIRST_TAG=$tag; fi
            DESTINATIONS="$DESTINATIONS --destination $tag"
          done

          # 3. Handle Push Flag
          PUSH_FLAG=""
          if [ "${{ inputs.push }}" = "false" ]; then
             PUSH_FLAG="--no-push"
          fi

          # 4. Handle Caching
          # Use provided cache-repo or default to the first tag with a /cache suffix
          CACHE_REPO="${{ inputs.cache-repo }}"
          if [ -z "$CACHE_REPO" ]; then
             # Remove existing tag if present and append /cache
             BASE_IMAGE=$(echo $FIRST_TAG | cut -d: -f1)
             CACHE_REPO="${BASE_IMAGE}/cache"
          fi

          # 5. Run Kaniko Executor
          # git:// protocol handles private repos via GIT_USERNAME/PASSWORD env vars.
          /kaniko/executor \
            --context "git://github.com/${{ github.repository }}#${{ github.sha }}" \
            --context-sub-path "${{ inputs.context }}" \
            --dockerfile "${{ inputs.file }}" \
            $DESTINATIONS \
            $PUSH_FLAG \
            --cache=true \
            --cache-repo "$CACHE_REPO" \
            --force
        env:
          GIT_USERNAME: ${{ github.actor }}
          GIT_PASSWORD: ${{ secrets.GITHUB_TOKEN }}
